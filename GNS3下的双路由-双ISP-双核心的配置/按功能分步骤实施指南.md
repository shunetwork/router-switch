# 网络架构按功能分步骤实施指南

## 概述

本文档将网络架构的实施步骤按照功能模块进行组织，而不是简单地按设备配置。每个功能模块包含相关的所有设备配置，确保实施的逻辑性和完整性。

## 功能模块划分

### 1. 基础网络连通性模块
### 2. 路由协议配置模块  
### 3. VLAN和网络分段模块
### 4. NAT和地址转换模块
### 5. VPN隧道和站点互联模块
### 6. QoS服务质量模块
### 7. 安全策略和访问控制模块
### 8. 监控和故障排除模块

---

## 第一阶段：基础网络连通性模块

### 目标
建立基本的网络连接，确保所有设备能够相互通信。

### 涉及设备
- ISP1, ISP2
- AveiroGW1, AveiroGW2  
- PortoGW1, PortoGW2
- Core1, Core2

### 实施步骤

#### 步骤1.1：配置ISP设备基础连接

**ISP1配置：**
```bash
# 基础配置
conf t
hostname ISP1
enable secret cisco123
ip domain-name isp1.local
crypto key generate rsa general-keys modulus 1024
username admin privilege 15 secret admin123

# 配置SSH访问
line vty 0 4
 transport input ssh
 login local
 exit

# 配置接口描述和IP地址
int f0/0
 description Connection to AveiroGW1-f0/1
 ip address 193.10.10.1 255.255.255.0
 no shut
 exit

int f0/1
 description Connection to PortoGW1-f0/1
 ip address 193.10.11.1 255.255.255.0
 no shut
 exit

# 启用CEF
ip cef

# 配置日志
logging host 193.10.10.1
logging trap informational

write
```

**ISP2配置：**
```bash
# 基础配置
conf t
hostname ISP2
enable secret cisco123
ip domain-name isp2.local
crypto key generate rsa general-keys modulus 1024
username admin privilege 15 secret admin123

# 配置SSH访问
line vty 0 4
 transport input ssh
 login local
 exit

# 配置接口描述和IP地址
int f0/0
 description Connection to AveiroGW2-f0/1
 ip address 193.10.20.1 255.255.255.0
 no shut
 exit

int f0/1
 description Connection to PortoGW2-f0/1
 ip address 193.10.21.1 255.255.255.0
 no shut
 exit

# 启用CEF
ip cef

# 配置日志
logging host 193.10.20.1
logging trap informational

write
```

#### 步骤1.2：配置网关设备基础接口

**AveiroGW1配置：**
```bash
# 基础配置
conf t
hostname AveiroGW1
enable secret cisco123
ip domain-name aveiro.local
crypto key generate rsa general-keys modulus 1024
username admin privilege 15 secret admin123

# 配置SSH访问
line vty 0 4
 transport input ssh
 login local
 exit

# 启用CEF
ip cef

# 内部接口配置
int f0/0
 description Internal Network to Core1-g0/0
 ip address 172.30.10.1 255.255.255.0
 no shut
 exit

int f1/1
 description Direct Connection to AveiroGW2-f1/1
 no switchport
 ip address 172.30.30.1 255.255.255.0
 no shut
 exit

int f1/0
 description Internal Network to Core2-g0/1
 no switchport
 ip address 172.30.40.1 255.255.255.0
 no shut
 exit

# 外部接口配置
int f0/1
 description External Network to ISP1
 ip address 193.10.10.2 255.255.255.0
 no shut
 exit

# 配置NTP时间同步
ntp server 193.10.10.1

# 配置日志
logging host 172.30.10.1
logging trap informational

write
```

**AveiroGW2配置：**
```bash
# 基础配置
conf t
hostname AveiroGW2
enable secret cisco123
ip domain-name aveiro.local
crypto key generate rsa general-keys modulus 1024
username admin privilege 15 secret admin123

# 配置SSH访问
line vty 0 4
 transport input ssh
 login local
 exit

# 启用CEF
ip cef

# 内部接口配置
int f0/0
 description Internal Network to Core2-g0/0
 ip address 172.30.20.1 255.255.255.0
 no shut
 exit

int f1/0
 description Internal Network to Core1-g1/0
 no switchport
 ip address 172.30.50.1 255.255.255.0
 no shut
 exit

int f1/1
 description Direct Connection to AveiroGW1-f1/1
 no switchport
 ip address 172.30.30.2 255.255.255.0
 no shut
 exit

# 外部接口配置
int f0/1
 description External Network to ISP2
 ip address 193.10.20.2 255.255.255.0
 no shut
 exit

# 配置NTP时间同步
ntp server 193.10.20.1

# 配置日志
logging host 172.30.20.1
logging trap informational

write
```

#### 步骤1.3：配置核心交换机基础连接

**Core1配置：**
```bash
# 基础配置
conf t
hostname Core1
enable secret cisco123
ip domain-name aveiro.local
crypto key generate rsa general-keys modulus 1024
username admin privilege 15 secret admin123

# 配置SSH访问
line vty 0 4
 transport input ssh
 login local
 exit

# 启用路由
ip routing
ip cef

# 连接网关的接口
int g0/0
 description Connection to AveiroGW1-f0/0
 no switchport
 ip address 172.30.10.2 255.255.255.0
 no shut
 exit

int g1/0
 description Connection to AveiroGW2-f1/0
 no switchport
 ip address 172.30.50.2 255.255.255.0
 no shut
 exit

# Core1和Core2之间的连接
int g3/0
 description Connection to Core2-g3/0
 no switchport
 ip address 172.30.100.1 255.255.255.0
 no shut
 exit

# 配置trunk接口（VLAN创建后配置）
int g1/1
 description Trunk to Old Building
 switchport trunk encapsulation dot1q
 switchport mode trunk
 switchport trunk allowed vlan 1,501,1002-1005
 switchport trunk native vlan 1
 exit

int g1/2
 description Trunk to NewBuilding2
 switchport trunk encapsulation dot1q
 switchport mode trunk
 switchport trunk allowed vlan 1,502,600,1002-1005
 switchport trunk native vlan 1
 exit

int g1/3
 description Trunk to NewBuilding1
 switchport trunk encapsulation dot1q
 switchport mode trunk
 switchport trunk allowed vlan 1,503,600,1002-1005
 switchport trunk native vlan 1
 exit

int g2/1
 description Trunk to Datacenter
 switchport trunk encapsulation dot1q
 switchport mode trunk
 switchport trunk allowed vlan 1,504,600,1002-1005
 switchport trunk native vlan 1
 exit

int g2/2
 description Trunk to DMZ
 switchport trunk encapsulation dot1q
 switchport mode trunk
 switchport trunk allowed vlan 1,505,600,1002-1005
 switchport trunk native vlan 1
 exit

int g3/1
 description Trunk to Core2
 switchport trunk encapsulation dot1q
 switchport mode trunk
 switchport trunk allowed vlan 1,560,600,1002-1005
 switchport trunk native vlan 1
 exit

# 配置NTP时间同步
ntp server 172.30.10.1

# 配置日志
logging host 172.30.10.1
logging trap informational

write
```

**Core2配置：**
```bash
# 基础配置
conf t
hostname Core2
enable secret cisco123
ip domain-name aveiro.local
crypto key generate rsa general-keys modulus 1024
username admin privilege 15 secret admin123

# 配置SSH访问
line vty 0 4
 transport input ssh
 login local
 exit

# 启用路由
ip routing
ip cef

# 连接网关的接口
int g0/0
 description Connection to AveiroGW2-f0/0
 no switchport
 ip address 172.30.20.2 255.255.255.0
 no shut
 exit

int g0/1
 description Connection to AveiroGW1-f1/0
 no switchport
 ip address 172.30.40.2 255.255.255.0
 no shut
 exit

# Core2和Core1之间的连接
int g3/0
 description Connection to Core1-g3/0
 no switchport
 ip address 172.30.100.2 255.255.255.0
 no shut
 exit

# 配置trunk接口（VLAN创建后配置）
int g1/1
 description Trunk to Old Building
 switchport trunk encapsulation dot1q
 switchport mode trunk
 switchport trunk allowed vlan 1,511,1002-1005
 switchport trunk native vlan 1
 exit

int g1/2
 description Trunk to NewBuilding2
 switchport trunk encapsulation dot1q
 switchport mode trunk
 switchport trunk allowed vlan 1,512,600,1002-1005
 switchport trunk native vlan 1
 exit

int g1/3
 description Trunk to NewBuilding1
 switchport trunk encapsulation dot1q
 switchport mode trunk
 switchport trunk allowed vlan 1,513,600,1002-1005
 switchport trunk native vlan 1
 exit

int g2/1
 description Trunk to Datacenter
 switchport trunk encapsulation dot1q
 switchport mode trunk
 switchport trunk allowed vlan 1,514,600,1002-1005
 switchport trunk native vlan 1
 exit

int g2/2
 description Trunk to DMZ
 switchport trunk encapsulation dot1q
 switchport mode trunk
 switchport trunk allowed vlan 1,515,600,1002-1005
 switchport trunk native vlan 1
 exit

int g3/1
 description Trunk to Core1
 switchport trunk encapsulation dot1q
 switchport mode trunk
 switchport trunk allowed vlan 1,560,600,1002-1005
 switchport trunk native vlan 1
 exit

# 配置NTP时间同步
ntp server 172.30.20.1

# 配置日志
logging host 172.30.20.1
logging trap informational

write
```

#### 步骤1.4：验证基础连通性

**测试命令：**
```bash
# 检查接口状态
show interfaces
show ip interface brief

# 检查接口描述
show interfaces description

# 测试连通性
ping 193.10.10.1
ping 193.10.10.2
ping 193.10.20.1
ping 193.10.20.2
ping 172.30.10.1
ping 172.30.10.2
ping 172.30.20.1
ping 172.30.20.2
ping 172.30.30.1
ping 172.30.30.2
ping 172.30.40.1
ping 172.30.40.2
ping 172.30.50.1
ping 172.30.50.2
ping 172.30.100.1
ping 172.30.100.2

# 检查路由表
show ip route

# 检查CEF状态
show ip cef
```

---

## 第二阶段：路由协议配置模块

### 目标
配置OSPF路由协议，实现动态路由学习和负载均衡。

### 涉及设备
- AveiroGW1, AveiroGW2
- Core1, Core2
- NewBuilding1, NewBuilding2
- Datacenter, DMZ

### 实施步骤

#### 步骤2.1：配置OSPF路由协议

**AveiroGW1 OSPF配置：**
```bash
# 启用OSPF
router ospf 1
 router-id 1.0.1.0
 network 172.30.10.0 0.0.0.255 area 0
 network 172.30.30.0 0.0.0.255 area 0
 network 172.30.40.0 0.0.0.255 area 0
 default-information originate always metric 5
 passive-interface default
 no passive-interface f0/0
 no passive-interface f1/1
 no passive-interface f1/0
 exit

```

**Core1 OSPF配置：**
```bash
# 启用OSPF
router ospf 1
 router-id 1.1.1.1
 network 172.30.10.0 0.0.0.255 area 0
 network 172.30.50.0 0.0.0.255 area 0
 network 172.30.100.0 0.0.0.255 area 0
 network 172.30.1.0 0.0.0.255 area 0
 network 172.30.2.0 0.0.0.255 area 0
 network 172.30.3.0 0.0.0.255 area 0
 network 172.30.4.0 0.0.0.255 area 0
 network 172.30.5.0 0.0.0.255 area 0
 network 172.30.60.0 0.0.0.255 area 0
 network 172.30.100.0 0.0.0.255 area 0
 passive-interface default
 no passive-interface g0/0
 no passive-interface g1/0
 no passive-interface g3/0
 no passive-interface g3/1
 exit

```

**Core2 OSPF配置：**
```bash
# 启用OSPF
router ospf 1
 router-id 2.2.2.2
 network 172.30.20.0 0.0.0.255 area 0
 network 172.30.40.0 0.0.0.255 area 0
 network 172.30.100.0 0.0.0.255 area 0
 network 172.30.11.0 0.0.0.255 area 0
 network 172.30.12.0 0.0.0.255 area 0
 network 172.30.13.0 0.0.0.255 area 0
 network 172.30.14.0 0.0.0.255 area 0
 network 172.30.15.0 0.0.0.255 area 0
 network 172.30.60.0 0.0.0.255 area 0
 network 172.30.100.0 0.0.0.255 area 0
 passive-interface default
 no passive-interface g0/0
 no passive-interface g0/1
 no passive-interface g3/0
 no passive-interface g3/1
 exit

```

#### 步骤2.2：配置静态路由和默认路由

**ISP1静态路由：**
```bash
# 配置到内部网络的路由
ip route 193.2.2.0 255.255.255.0 193.10.11.2
ip route 193.1.1.0 255.255.255.0 193.10.10.2
```

**ISP2静态路由：**
```bash
# 配置到内部网络的路由
ip route 193.2.2.0 255.255.255.0 193.10.21.2
ip route 193.1.1.0 255.255.255.0 193.10.20.2
```

**AveiroGW1默认路由：**
```bash
# 配置默认路由
ip route 0.0.0.0 0.0.0.0 193.10.10.1
```

**AveiroGW2默认路由：**
```bash
# 配置默认路由
ip route 0.0.0.0 0.0.0.0 193.10.20.1
```

**Core1默认路由：**
```bash
# 配置默认路由（通过AveiroGW1）
ip route 0.0.0.0 0.0.0.0 172.30.10.1 60
```

**Core2默认路由：**
```bash
# 配置默认路由（通过AveiroGW2）
ip route 0.0.0.0 0.0.0.0 172.30.20.1 60
```

#### 步骤2.3：验证路由配置

**验证命令：**
```bash
# 检查OSPF邻居
show ospf neighbor
show ospf neighbor detail
show ospf database
show ospf database summary

# 检查路由表
show ip route
show ip route ospf

# 检查OSPF接口
show ip ospf interface
show ip ospf interface brief

# 检查OSPF进程
show ip ospf

# 检查路由重分发
show ip ospf database external
show ip route 0.0.0.0

# 测试路由连通性
traceroute 8.8.8.8
```

---

## 第三阶段：VLAN和网络分段模块

### 目标
配置VLAN实现网络分段，为不同部门和服务提供独立的网络环境。

### 涉及设备
- Core1, Core2
- NewBuilding1, NewBuilding2
- Datacenter, DMZ

### 实施步骤

#### 步骤3.1：创建VLAN

**⚠️ 重要提醒：VLAN的创建必须在trunk接口配置之前完成！**

**Core1 VLAN配置：**
```bash
# 创建VLAN - 必须在trunk配置之前完成
vlan database
vlan 501 name Management
vlan 502 name Sales
vlan 503 name Engineering
vlan 504 name HR
vlan 505 name Finance
vlan 560 name Datacenter
vlan 600 name DMZ
exit
```

**Core2 VLAN配置：**
```bash
# 创建VLAN - 必须在trunk配置之前完成
vlan database
vlan 511 name Management_Extended
vlan 512 name Sales_Extended
vlan 513 name Engineering_Extended
vlan 514 name HR_Extended
vlan 515 name Finance_Extended
vlan 560 name Datacenter
vlan 600 name DMZ
exit
```

**NewBuilding1 VLAN配置：**
```bash
# 创建VLAN - 必须在trunk配置之前完成
vlan database
vlan 503 name Engineering
vlan 513 name Engineering_Extended
vlan 551 name Lab1
vlan 552 name Lab2
vlan 553 name Lab3
vlan 561 name Server1
vlan 562 name Server2
vlan 563 name Server3
vlan 564 name Server4
vlan 600 name DMZ
exit
```

#### 步骤3.2：配置VLAN接口

**Core1 VLAN接口配置：**
```bash
# 管理VLAN
interface Vlan501
 ip address 172.30.1.1 255.255.255.0
 no shut
 no autostate
 exit

# 销售VLAN
interface Vlan502
 ip address 172.30.2.1 255.255.255.0
 no shut
 no autostate
 exit

# 工程VLAN
interface Vlan503
 ip address 172.30.3.1 255.255.255.0
 no shut
 no autostate
 exit

# HR VLAN
interface Vlan504
 ip address 172.30.4.1 255.255.255.0
 no shut
 no autostate
 exit

# 财务VLAN
interface Vlan505
 ip address 172.30.5.1 255.255.255.0
 no shut
 no autostate
 exit

# 数据中心VLAN
interface Vlan560
 ip address 172.30.60.1 255.255.255.0
 no shut
 no autostate
 exit

# DMZ VLAN
interface Vlan600
 ip address 172.30.100.1 255.255.255.0
 no shut
 no autostate
 exit
```

**Core2 VLAN接口配置：**
```bash
# 管理扩展VLAN
interface Vlan511
 ip address 172.30.11.1 255.255.255.0
 no shut
 no autostate
 exit

# 销售扩展VLAN
interface Vlan512
 ip address 172.30.12.1 255.255.255.0
 no shut
 no autostate
 exit

# 工程扩展VLAN
interface Vlan513
 ip address 172.30.13.1 255.255.255.0
 no shut
 no autostate
 exit

# HR扩展VLAN
interface Vlan514
 ip address 172.30.14.1 255.255.255.0
 no shut
 no autostate
 exit

# 财务扩展VLAN
interface Vlan515
 ip address 172.30.15.1 255.255.255.0
 no shut
 no autostate
 exit

# 数据中心VLAN
interface Vlan560
 ip address 172.30.60.2 255.255.255.0
 no shut
 no autostate
 exit

# DMZ VLAN
interface Vlan600
 ip address 172.30.100.2 255.255.255.0
 no shut
 no autostate
 exit
```

#### 步骤3.3：配置Trunk接口

**⚠️ 重要提醒：只有在VLAN创建完成后才能配置trunk接口！**

**Core1 Trunk配置：**
```bash
# 连接NewBuilding1的Trunk
int f1/1
 switchport mode trunk
 switchport trunk allowed vlan 1,501,1002-1005
exit

# 连接NewBuilding2的Trunk
int f1/2
 switchport mode trunk
 switchport trunk allowed vlan 1,502,600,1002-1005
exit

# 连接Datacenter的Trunk
int f1/15
 switchport mode trunk
 switchport trunk allowed vlan 1,560,600,1002-1005
exit
```

**Core2 Trunk配置：**
```bash
# 连接NewBuilding2的Trunk
int f1/1
 switchport mode trunk
 switchport trunk allowed vlan 1,502,600,1002-1005
exit

# 连接Datacenter的Trunk
int f1/2
 switchport mode trunk
 switchport trunk allowed vlan 1,560,600,1002-1005
exit

# 连接DMZ的Trunk
int f1/15
 switchport mode trunk
 switchport trunk allowed vlan 1,600,1002-1005
exit
```

#### 步骤3.4：验证VLAN配置

**验证命令：**
```bash
# 检查VLAN
show vlan
show vlan brief
show vlan summary
show interfaces trunk
show interfaces trunk allowed-vlan

# 检查VLAN接口
show ip interface vlan 501
show ip interface vlan 502
show ip interface vlan 503
show ip interface vlan 504
show ip interface vlan 505
show ip interface vlan 560
show ip interface vlan 600

# 检查VLAN接口状态
show ip interface brief | include Vlan

# 测试VLAN间连通性
ping 172.30.1.1
ping 172.30.1.2
ping 172.30.2.1
ping 172.30.2.2
ping 172.30.3.1
ping 172.30.3.2
ping 172.30.4.1
ping 172.30.4.2
ping 172.30.5.1
ping 172.30.5.2
ping 172.30.60.1
ping 172.30.60.2
ping 172.30.100.1
ping 172.30.100.2

# 检查VLAN路由
show ip route | include 172.30

# 检查VLAN OSPF状态
show ip ospf interface vlan 501
show ip ospf interface vlan 502
show ip ospf interface vlan 503
```

---

## 第四阶段：NAT和地址转换模块

### 目标
配置NAT实现内网到外网的地址转换，支持负载均衡和冗余。

### 涉及设备
- AveiroGW1, AveiroGW2
- Core1, Core2

### 实施步骤

#### 步骤4.1：配置NAT接口方向

**AveiroGW1 NAT配置：**
```bash
# 配置NAT接口方向
int f0/0
 ip nat inside
 exit

int f1/1
 ip nat inside
 exit

int f1/0
 ip nat inside
 exit

int f0/1
 ip nat outside
 exit

# 配置NAT访问控制列表
access-list 1 permit 172.30.0.0 0.0.255.255
access-list 1 permit 172.31.0.0 0.0.255.255

# 配置NAT地址池
ip nat pool POOLR 193.1.1.128 193.1.1.255 netmask 255.255.255.128

# 配置Stateful NAT
ip nat Stateful id 3
 primary 172.30.10.1
 peer 172.30.20.1
 mapping-id 10
 exit

# 应用NAT转换
ip nat inside source list 1 pool POOLR mapping-id 10 overload
```

**Core1 NAT配置：**
```bash
# 配置NAT接口方向
int g0/0
 ip nat inside
 exit

int g1/0
 ip nat inside
 exit

# VLAN接口NAT配置
int vlan501
 ip nat inside
 exit

int vlan502
 ip nat inside
 exit

int vlan503
 ip nat inside
 exit

int vlan504
 ip nat inside
 exit

int vlan505
 ip nat inside
 exit

int vlan560
 ip nat inside
 exit

int vlan600
 ip nat inside
 exit

# 配置RIP路由协议
router rip
 version 2
 no auto-summary
 redistribute ospf 1 metric 10
 network 172.30.1.0
 network 172.30.2.0
 network 172.30.3.0
 network 172.30.4.0
 network 172.30.5.0
 exit

# 配置OSPF重分发
router ospf 1
 redistribute rip metric 10 subnets
 exit
```

**Core2 NAT配置：**
```bash
# 配置NAT接口方向
int g0/0
 ip nat inside
 exit

int g0/1
 ip nat inside
 exit

# VLAN接口NAT配置
int vlan511
 ip nat inside
 exit

int vlan512
 ip nat inside
 exit

int vlan513
 ip nat inside
 exit

int vlan514
 ip nat inside
 exit

int vlan515
 ip nat inside
 exit

int vlan560
 ip nat inside
 exit

int vlan600
 ip nat inside
 exit

# 配置RIP路由协议
router rip
 version 2
 no auto-summary
 redistribute ospf 1 metric 20
 network 172.30.11.0
 network 172.30.12.0
 network 172.30.13.0
 network 172.30.14.0
 network 172.30.15.0
 exit

# 配置OSPF重分发
router ospf 1
 redistribute rip metric 20 subnets
 exit
```

#### 步骤4.2：配置AveiroGW2 NAT

**AveiroGW2 NAT配置：**
```bash
# 配置NAT接口方向
int f0/0
 ip nat inside
 exit

int f1/0
 ip nat inside
 exit

int f1/1
 ip nat inside
 exit

int f0/1
 ip nat outside
 exit

# 配置NAT访问控制列表
access-list 1 permit 172.30.0.0 0.0.255.255
access-list 1 permit 172.31.0.0 0.0.255.255

# 配置NAT地址池
ip nat pool POOLR 193.1.1.128 193.1.1.255 netmask 255.255.255.128

# 配置Stateful NAT
ip nat Stateful id 2
 backup 172.30.20.1
 peer 172.30.10.1
 mapping-id 10
 exit

# 应用NAT转换
ip nat inside source list 1 pool POOLR mapping-id 10 overload
```

#### 步骤4.3：验证NAT配置

**验证命令：**
```bash
# 检查NAT转换表
show ip nat translations
show ip nat translations verbose
show ip nat statistics
show ip nat pool

# 检查访问控制列表
show access-lists
show ip access-lists

# 检查NAT接口状态
show ip nat interfaces

# 测试NAT功能
# 从内网ping外网地址，然后检查NAT转换表
ping 8.8.8.8 source vlan 501
ping 8.8.8.8 source vlan 502

# 检查NAT转换统计
show ip nat statistics
show ip nat translations active
```

---

## 第五阶段：VPN隧道和站点互联模块

### 目标
配置IPSec VPN隧道，实现Aveiro和Porto站点之间的安全互联。

### 涉及设备
- AveiroGW1, AveiroGW2
- PortoGW1, PortoGW2

### 实施步骤

#### 步骤5.1：配置ISAKMP策略

**AveiroGW1 ISAKMP配置：**
```bash
# 配置ISAKMP策略
crypto isakmp policy 30
 authentication pre-share
 encryption des
 hash sha
 group 2
 lifetime 86400
 exit

# 配置预共享密钥
crypto isakmp key xpto-sitecom address 193.10.11.2

# 配置ISAKMP keepalive
crypto isakmp keepalive 10 3
```

#### 步骤5.2：配置IPSec转换集

**AveiroGW1 IPSec配置：**
```bash
# 配置IPSec转换集
crypto ipsec transform-set authT ah-sha-hmac
crypto ipsec transform-set cipherT esp-des
crypto ipsec transform-set auth_ciphT ah-sha-hmac esp-des

# 配置IPSec配置文件
crypto ipsec profile ipsec-profile-01
 set transform-set authT cipherT auth_ciphT
 exit

# 配置IPSec安全关联
crypto ipsec security-association lifetime seconds 3600
crypto ipsec security-association lifetime kilobytes 4608000
```

#### 步骤5.3：配置隧道接口

**AveiroGW1隧道配置：**
```bash
# 创建隧道接口
interface Tunnel 0
 ip nat outside
 ip unnumbered FastEthernet0/1
 tunnel source 193.10.10.2
 tunnel destination 193.10.11.2
 tunnel mode ipsec ipv4
 tunnel protection ipsec profile ipsec-profile-01
 no shut
 exit

# 配置隧道路由
ip route 193.2.2.0 255.255.255.0 Tunnel0
```

**AveiroGW2隧道配置：**
```bash
# 创建隧道接口
interface Tunnel 0
 ip nat outside
 ip unnumbered FastEthernet0/1
 tunnel source 193.10.20.2
 tunnel destination 193.10.21.2
 tunnel mode ipsec ipv4
 tunnel protection ipsec profile ipsec-profile-01
 no shut
 exit

# 配置隧道路由
ip route 193.2.2.0 255.255.255.0 Tunnel0
ip route 0.0.0.0 0.0.0.0 193.10.20.1
```

#### 步骤5.4：验证VPN配置

**验证命令：**
```bash
# 检查ISAKMP状态
show crypto isakmp sa
show crypto isakmp sa detail
show crypto isakmp policy
show crypto isakmp key

# 检查IPSec状态
show crypto ipsec sa
show crypto ipsec sa detail
show crypto ipsec transform-set
show crypto ipsec profile

# 检查隧道状态
show interface tunnel 0
show ip route

# 检查隧道统计
show interface tunnel 0 | include packets

# 测试站点间连通性
ping 193.2.2.1
ping 193.2.2.1 source 172.30.10.1
traceroute 193.2.2.1

# 检查VPN日志
show logging | include crypto
show logging | include tunnel
```

---

## 第六阶段：QoS服务质量模块

### 目标
配置QoS策略，为关键业务流量提供服务质量保证。

### 涉及设备
- NewBuilding1, NewBuilding2
- Core1, Core2

### 实施步骤

#### 步骤6.1：配置访问控制列表

**NewBuilding1 ACL配置：**
```bash
# 定义高优先级流量（EF类）
access-list 101 permit ip 193.1.1.16 0.0.0.15 any
access-list 101 deny ip any any

# 定义语音流量
access-list 102 permit udp any any range 16384 32767
access-list 102 permit tcp any any eq 5060

# 定义视频流量
access-list 103 permit tcp any any eq 554
access-list 103 permit udp any any range 1024 65535

# 定义管理流量
access-list 104 permit tcp any any eq 22
access-list 104 permit tcp any any eq 23
access-list 104 permit tcp any any eq 80
access-list 104 permit tcp any any eq 443
```

#### 步骤6.2：配置类映射

**NewBuilding1类映射配置：**
```bash
# 配置EF类（高优先级）
class-map match-all EF
 match access-group 101
 exit

# 配置语音类
class-map match-all VOICE
 match access-group 102
 match ip dscp 46
 exit

# 配置视频类
class-map match-all VIDEO
 match access-group 103
 match ip dscp 34
 exit

# 配置管理类
class-map match-all MANAGEMENT
 match access-group 104
 match ip dscp 48
 exit

# 配置Premium类
class-map match-all PREMIUM
 match ip dscp 46
 exit

# 配置Best-Effort类
class-map match-all BEST-EFFORT
 match ip dscp 0
 exit

# 配置默认类
class-map match-all DEFAULT
 match any
 exit
```

#### 步骤6.3：配置策略映射

**NewBuilding1策略映射配置：**
```bash
# 配置DSCP标记策略
policy-map SETDSCP
 class EF
  set ip dscp 46
  exit
 class VOICE
  set ip dscp 46
  exit
 class VIDEO
  set ip dscp 34
  exit
 class MANAGEMENT
  set ip dscp 48
  exit
 class DEFAULT
  set ip dscp 0
  exit
 exit

# 配置边缘QoS策略
policy-map EDGE
 class VOICE
  priority percent 20
  exit
 class VIDEO
  bandwidth percent 30
  exit
 class PREMIUM
  priority percent 40
  exit
 class MANAGEMENT
  bandwidth percent 10
  exit
 class BEST-EFFORT
  police 16000 2000 2000 conform-action set-dscp-transmit 0
  exit
 class DEFAULT
  bandwidth percent 40
  exit
 exit

# 配置核心QoS策略
policy-map CORE
 class VOICE
  priority percent 25
  exit
 class VIDEO
  bandwidth percent 35
  exit
 class PREMIUM
  bandwidth percent 30
  exit
 class MANAGEMENT
  bandwidth percent 10
  exit
 exit
```

#### 步骤6.4：应用QoS策略

**NewBuilding1策略应用：**
```bash
# 在VLAN接口上应用策略
int vlan503
 service-policy output EDGE
 service-policy input SETDSCP
 exit

int vlan513
 service-policy output EDGE
 service-policy input SETDSCP
 exit

int vlan551
 service-policy output EDGE
 service-policy input SETDSCP
 exit

int vlan552
 service-policy output EDGE
 service-policy input SETDSCP
 exit

int vlan553
 service-policy output EDGE
 service-policy input SETDSCP
 exit

int vlan561
 service-policy input SETDSCP
 service-policy output CORE
 exit

int vlan562
 service-policy input SETDSCP
 service-policy output CORE
 exit

int vlan563
 service-policy input SETDSCP
 service-policy output CORE
 exit

int vlan564
 service-policy input SETDSCP
 service-policy output CORE
 exit
```

**Core1策略应用：**
```bash
# 在核心接口上应用策略
int g0/0
 service-policy output CORE
 exit

int g1/0
 service-policy output CORE
 exit

int g3/1
 service-policy output CORE
 exit
```

#### 步骤6.5：验证QoS配置

**验证命令：**
```bash
# 检查策略映射
show policy-map
show policy-map SETDSCP
show policy-map EDGE
show policy-map CORE
show class-map
show class-map EF
show class-map VOICE
show class-map VIDEO

# 检查接口策略应用
show policy-map interface
show policy-map interface vlan 503
show policy-map interface vlan 513
show policy-map interface vlan 551
show policy-map interface g0/0

# 检查流量统计
show interfaces vlan 503 | include packets
show interfaces vlan 513 | include packets
show interfaces g0/0 | include packets

# 检查QoS统计
show policy-map interface vlan 503 input
show policy-map interface vlan 503 output
show policy-map interface vlan 513 input
show policy-map interface vlan 513 output

# 检查DSCP标记
show policy-map interface vlan 561 input class EF
show policy-map interface vlan 561 input class VOICE
show policy-map interface vlan 561 input class VIDEO

# 检查队列统计
show policy-map interface vlan 503 output class VOICE
show policy-map interface vlan 503 output class VIDEO
show policy-map interface vlan 503 output class PREMIUM

# 检查访问控制列表
show access-lists 101
show access-lists 102
show access-lists 103
show access-lists 104
```

---

## 第七阶段：安全策略和访问控制模块

### 目标
配置安全策略，实现网络访问控制和流量过滤。

### 涉及设备
- 所有网关设备
- 所有核心交换机

### 实施步骤

#### 步骤7.1：配置基础安全策略

**AveiroGW1安全配置：**
```bash
# 配置SSH访问
ip domain-name aveiro.local
crypto key generate rsa general-keys modulus 2048
line vty 0 4
 transport input ssh
 login local
 exec-timeout 10 0
 exit

# 配置本地用户
username admin privilege 15 secret admin123
username operator privilege 1 secret operator123

# 配置控制台安全
line con 0
 exec-timeout 5 0
 login local
 exit

# 配置特权模式安全
enable secret cisco123
service password-encryption

# 配置安全访问控制
access-list 10 permit 172.30.1.0 0.0.0.255
access-list 10 permit 172.30.10.0 0.0.0.255
access-list 10 deny any

# 应用ACL到VTY线路
line vty 0 4
 access-class 10 in
 exit

# 配置SSH安全
ip ssh version 2
ip ssh time-out 60
ip ssh authentication-retries 3
```

#### 步骤7.2：配置访问控制列表

**Core1 ACL配置：**
```bash
# 配置管理访问控制
access-list 10 permit 172.30.1.0 0.0.0.255
access-list 10 permit 172.30.10.0 0.0.0.255
access-list 10 permit 172.30.20.0 0.0.0.255
access-list 10 deny any

# 配置VLAN间访问控制
access-list 100 permit ip 172.30.1.0 0.0.0.255 172.30.0.0 0.0.255.255
access-list 100 permit ip 172.30.2.0 0.0.0.255 172.30.0.0 0.0.255.255
access-list 100 permit ip 172.30.3.0 0.0.0.255 172.30.0.0 0.0.255.255
access-list 100 deny ip 172.30.4.0 0.0.0.255 172.30.5.0 0.0.0.255
access-list 100 permit ip any any

# 配置外部访问控制
access-list 110 permit tcp 172.30.0.0 0.0.255.255 any eq 80
access-list 110 permit tcp 172.30.0.0 0.0.255.255 any eq 443
access-list 110 permit tcp 172.30.0.0 0.0.255.255 any eq 53
access-list 110 permit udp 172.30.0.0 0.0.255.255 any eq 53
access-list 110 deny ip any any

# 应用ACL到VTY线路
line vty 0 4
 access-class 10 in
 exit

# 应用ACL到VLAN接口
int vlan501
 ip access-group 100 in
 exit

int vlan502
 ip access-group 100 in
 exit

int vlan503
 ip access-group 100 in
 exit
```

#### 步骤7.3：配置端口安全

**NewBuilding1端口安全配置：**
```bash
# 配置端口安全
int f0/1
 switchport port-security
 switchport port-security maximum 2
 switchport port-security violation restrict
 switchport port-security mac-address sticky
 switchport port-security aging time 1440
 switchport port-security aging type inactivity
 exit

int f0/2
 switchport port-security
 switchport port-security maximum 1
 switchport port-security violation shutdown
 switchport port-security mac-address 0000.1111.2222
 exit

int f0/3
 switchport port-security
 switchport port-security maximum 3
 switchport port-security violation protect
 switchport port-security mac-address sticky
 exit

# 配置端口安全全局设置
switchport port-security aging time 1440
switchport port-security aging type inactivity
```

**Core1端口安全配置：**
```bash
# 配置trunk端口安全
int g1/1
 switchport port-security
 switchport port-security maximum 1
 switchport port-security violation restrict
 exit

int g1/2
 switchport port-security
 switchport port-security maximum 1
 switchport port-security violation restrict
 exit

int g1/3
 switchport port-security
 switchport port-security maximum 1
 switchport port-security violation restrict
 exit
```

#### 步骤7.4：验证安全配置

**验证命令：**
```bash
# 检查SSH配置
show ip ssh
show crypto key mypubkey rsa
show users
show line vty

# 检查访问控制列表
show access-lists
show access-lists 10
show access-lists 100
show access-lists 110
show ip access-lists

# 检查端口安全
show port-security
show port-security interface f0/1
show port-security interface f0/2
show port-security interface f0/3
show port-security address

# 检查安全日志
show logging | include security
show logging | include port-security
show logging | include access-list

# 检查用户配置
show running-config | include username
show running-config | include enable secret

# 检查接口安全状态
show interfaces f0/1 | include security
show interfaces f0/2 | include security
show interfaces f0/3 | include security

# 测试安全策略
# 尝试从不允许的IP地址SSH连接
# 检查端口安全违规
show port-security violations
```

---

## 第八阶段：监控和故障排除模块

### 目标
配置网络监控和故障排除工具，确保网络稳定运行。

### 实施步骤

#### 步骤8.1：配置SNMP监控

**Core1 SNMP配置：**
```bash
# 配置SNMP
snmp-server community public RO
snmp-server community private RW
snmp-server community secure RW
snmp-server location "Aveiro Campus - Core1"
snmp-server contact "Network Admin - admin@aveiro.local"
snmp-server enable traps
snmp-server enable traps snmp authentication linkdown linkup coldstart warmstart
snmp-server enable traps ospf
snmp-server enable traps bgp
snmp-server enable traps vtp
snmp-server enable traps port-security
snmp-server host 172.30.1.100 public
snmp-server host 172.30.1.100 private
snmp-server host 172.30.1.100 secure
```

**AveiroGW1 SNMP配置：**
```bash
# 配置SNMP
snmp-server community public RO
snmp-server community private RW
snmp-server location "Aveiro Campus - Gateway1"
snmp-server contact "Network Admin - admin@aveiro.local"
snmp-server enable traps
snmp-server enable traps snmp authentication linkdown linkup coldstart warmstart
snmp-server enable traps ospf
snmp-server enable traps bgp
snmp-server enable traps crypto
snmp-server host 172.30.1.100 public
snmp-server host 172.30.1.100 private
```

#### 步骤8.2：配置日志记录

**AveiroGW1日志配置：**
```bash
# 配置日志记录
logging host 172.30.1.100
logging host 172.30.1.101
logging facility local0
logging trap informational
logging source-interface vlan 501
logging buffered 64000
logging console informational
logging monitor informational
logging timestamp
logging sequence-numbers
```

**Core1日志配置：**
```bash
# 配置日志记录
logging host 172.30.1.100
logging host 172.30.1.101
logging facility local0
logging trap informational
logging source-interface vlan 501
logging buffered 64000
logging console informational
logging monitor informational
logging timestamp
logging sequence-numbers
```

**NewBuilding1日志配置：**
```bash
# 配置日志记录
logging host 172.30.1.100
logging facility local0
logging trap informational
logging source-interface vlan 503
logging buffered 32000
logging console warnings
logging monitor informational
logging timestamp
logging sequence-numbers
```

#### 步骤8.3：配置网络时间协议

**Core1 NTP配置：**
```bash
# 配置NTP
ntp server 193.10.10.1 prefer
ntp server 193.10.20.1
ntp server 172.30.10.1
ntp update-calendar
ntp master 1
ntp source vlan 501
```

**AveiroGW1 NTP配置：**
```bash
# 配置NTP
ntp server 193.10.10.1 prefer
ntp server 193.10.20.1
ntp update-calendar
ntp source f0/1
```

**NewBuilding1 NTP配置：**
```bash
# 配置NTP
ntp server 172.30.1.1 prefer
ntp server 172.30.11.1
ntp update-calendar
ntp source vlan 503
```

**ISP1 NTP配置：**
```bash
# 配置NTP（作为时间源）
ntp master 1
ntp source f0/0
```

#### 步骤8.4：创建监控脚本

**基础监控脚本：**
```bash
#!/bin/bash
# 网络监控脚本 - network_monitor.sh

echo "=========================================="
echo "网络监控报告 - $(date)"
echo "=========================================="

# 检查接口状态
echo "=== 接口状态检查 ==="
show interfaces | grep -E "(FastEthernet|GigabitEthernet)" | grep -E "(up|down)"
show ip interface brief | grep -E "(up|down)"

# 检查OSPF邻居
echo "=== OSPF邻居状态 ==="
show ospf neighbor
show ospf neighbor detail


# 检查NAT转换
echo "=== NAT转换统计 ==="
show ip nat statistics
show ip nat translations active

# 检查VPN状态
echo "=== VPN隧道状态 ==="
show crypto isakmp sa
show crypto ipsec sa
show interface tunnel 0

# 检查VLAN状态
echo "=== VLAN状态检查 ==="
show vlan brief
show interfaces trunk

# 检查QoS状态
echo "=== QoS状态检查 ==="
show policy-map interface | head -20

# 检查端口安全
echo "=== 端口安全状态 ==="
show port-security

# 检查系统资源
echo "=== 系统资源状态 ==="
show memory
show processes cpu
show version | head -5

# 检查日志
echo "=== 最近日志 ==="
show logging | tail -10

echo "=========================================="
echo "监控报告完成 - $(date)"
echo "=========================================="
```

**高级监控脚本：**
```bash
#!/bin/bash
# 高级网络监控脚本 - advanced_monitor.sh

# 配置变量
LOG_FILE="/var/log/network_monitor.log"
ALERT_EMAIL="admin@aveiro.local"

# 检查关键接口状态
check_interfaces() {
    echo "检查关键接口状态..."
    DOWN_INTERFACES=$(show ip interface brief | grep "down" | wc -l)
    if [ $DOWN_INTERFACES -gt 0 ]; then
        echo "警告：发现 $DOWN_INTERFACES 个接口处于down状态"
        show ip interface brief | grep "down"
    fi
}

# 检查OSPF邻居状态
check_ospf_neighbors() {
    echo "检查OSPF邻居状态..."
    TOTAL_NEIGHBORS=$(show ospf neighbor | grep -c "FULL")
    if [ $TOTAL_NEIGHBORS -lt 2 ]; then
        echo "警告：OSPF邻居数量不足"
        show ospf neighbor
    fi
}

# 检查VPN隧道状态
check_vpn_tunnels() {
    echo "检查VPN隧道状态..."
    TUNNEL_STATUS=$(show crypto isakmp sa | grep -c "QM_IDLE")
    if [ $TUNNEL_STATUS -eq 0 ]; then
        echo "警告：VPN隧道未建立"
        show crypto isakmp sa
    fi
}

# 检查NAT转换
check_nat_translations() {
    echo "检查NAT转换..."
    NAT_COUNT=$(show ip nat translations | wc -l)
    if [ $NAT_COUNT -gt 100 ]; then
        echo "警告：NAT转换数量过多 ($NAT_COUNT)"
    fi
}

# 主监控函数
main_monitor() {
    echo "开始网络监控检查..."
    check_interfaces
    check_ospf_neighbors
    check_vpn_tunnels
    check_nat_translations
    echo "监控检查完成"
}

# 执行监控
main_monitor >> $LOG_FILE 2>&1
```

#### 步骤8.5：验证监控配置

**验证命令：**
```bash
# 检查SNMP配置
show snmp community
show snmp host
show snmp user
show snmp group
show snmp view

# 检查日志配置
show logging
show logging history
show logging summary
show logging on

# 检查NTP状态
show ntp status
show ntp associations
show ntp config
show clock

# 检查系统监控
show memory
show processes cpu
show processes memory
show version
show inventory

# 检查接口统计
show interfaces counters
show interfaces counters errors
show interfaces counters rates

# 检查路由统计
show ip route summary
show ospf database summary

# 检查VLAN统计
show vlan summary
show interfaces trunk summary

# 检查QoS统计
show policy-map interface summary
show class-map summary

# 检查安全统计
show port-security summary
show access-lists summary

# 检查VPN统计
show crypto isakmp sa summary
show crypto ipsec sa summary

# 检查NAT统计
show ip nat statistics
show ip nat translations summary

# 测试监控功能
# 测试SNMP查询
snmpwalk -v2c -c public 172.30.1.1 1.3.6.1.2.1.1.1.0

# 测试日志发送
send log "测试日志消息"

# 测试NTP同步
ntpdate 193.10.10.1
```

---

## 实施顺序和依赖关系

### 实施顺序
1. **第一阶段**：基础网络连通性（必须先完成）
2. **第二阶段**：路由协议配置（依赖第一阶段）
3. **第三阶段**：VLAN和网络分段（依赖第二阶段）
4. **第四阶段**：NAT和地址转换（依赖第三阶段）
5. **第五阶段**：VPN隧道和站点互联（依赖第一阶段）
6. **第六阶段**：QoS服务质量（依赖第三阶段）
7. **第七阶段**：安全策略和访问控制（可并行实施）
8. **第八阶段**：监控和故障排除（最后实施）

### 关键依赖关系
- **VLAN创建必须在trunk接口配置之前完成** ⚠️
- 路由协议配置必须在VLAN配置之前完成
- NAT配置必须在VLAN接口配置完成后进行
- VPN配置可以与其他模块并行实施
- QoS配置必须在VLAN配置完成后进行

### 测试验证点
每个阶段完成后必须进行以下测试：
1. 连通性测试
2. 功能测试
3. 性能测试
4. 故障切换测试

---

## 故障排除指南

### 常见问题及解决方案

#### 1. 基础连通性问题
**症状**：设备间无法ping通
**排查步骤**：
- 检查物理连接
- 验证IP地址配置
- 检查接口状态
- 验证子网掩码

#### 1.1. VLAN配置顺序问题
**症状**：trunk接口无法正常工作，VLAN流量无法通过
**排查步骤**：
- 检查VLAN是否已创建：`show vlan`
- 验证VLAN创建是否在trunk配置之前完成
- 检查trunk接口允许的VLAN列表：`show interfaces trunk`
- 确认VLAN ID在trunk允许列表中

#### 2. OSPF邻居问题
**症状**：OSPF邻居无法建立
**排查步骤**：
- 检查网络掩码匹配
- 验证区域ID配置
- 检查认证配置
- 验证网络类型

#### 3. NAT转换问题
**症状**：内网无法访问外网
**排查步骤**：
- 检查访问控制列表
- 验证NAT池配置
- 检查接口NAT方向
- 验证路由配置

#### 4. VPN隧道问题
**症状**：站点间无法通信
**排查步骤**：
- 检查ISAKMP配置
- 验证预共享密钥
- 检查网络连通性
- 验证IPSec配置

#### 5. QoS不生效
**症状**：流量优先级未按预期处理
**排查步骤**：
- 检查类映射配置
- 验证策略映射
- 检查接口应用
- 验证流量匹配

---

## 配置备份和恢复

### 配置备份策略
1. **每日备份**：自动备份所有设备配置
2. **变更前备份**：每次配置变更前手动备份
3. **版本控制**：使用版本控制系统管理配置

### 备份脚本示例
```bash
#!/bin/bash
# 设备配置备份脚本

DEVICES=("AveiroGW1" "AveiroGW2" "Core1" "Core2" "NewBuilding1" "NewBuilding2")

for device in "${DEVICES[@]}"; do
    echo "备份 $device 配置..."
    # 这里添加具体的备份命令
    # 例如：scp admin@$device:running-config ./backup/$device-$(date +%Y%m%d).cfg
done
```

### 恢复流程
1. 确认故障设备
2. 选择正确的备份版本
3. 恢复配置
4. 验证功能
5. 更新文档

---

## 第九阶段：配置验证和测试脚本

### 目标
提供完整的配置验证和测试脚本，确保所有配置正确实施并正常工作。

### 实施步骤

#### 步骤9.1：创建配置验证脚本

**完整配置验证脚本：**
```bash
#!/bin/bash
# 完整配置验证脚本 - config_validation.sh

echo "=========================================="
echo "网络配置验证报告 - $(date)"
echo "=========================================="

# 验证基础连通性
validate_connectivity() {
    echo "=== 验证基础连通性 ==="
    
    # 测试网关连通性
    ping -c 3 193.10.10.1
    ping -c 3 193.10.10.2
    ping -c 3 193.10.20.1
    ping -c 3 193.10.20.2
    
    # 测试内部网络连通性
    ping -c 3 172.30.10.1
    ping -c 3 172.30.10.2
    ping -c 3 172.30.20.1
    ping -c 3 172.30.20.2
    ping -c 3 172.30.30.1
    ping -c 3 172.30.30.2
    
}

# 验证路由配置
validate_routing() {
    echo "=== 验证路由配置 ==="
    
    # 检查OSPF邻居
    show ospf neighbor
    show ospf neighbor detail
    
    # 检查路由表
    show ip route
    
    # 检查默认路由
    show ip route 0.0.0.0
    
    # 测试路由连通性
    traceroute 8.8.8.8
}

# 验证VLAN配置
validate_vlan() {
    echo "=== 验证VLAN配置 ==="
    
    # 检查VLAN
    show vlan
    show vlan brief
    show vlan summary
    
    # 检查trunk接口
    show interfaces trunk
    show interfaces trunk allowed-vlan
    
    # 检查VLAN接口
    show ip interface brief | include Vlan
    
    # 测试VLAN连通性
    ping -c 3 172.30.1.1
    ping -c 3 172.30.1.2
    ping -c 3 172.30.2.1
    ping -c 3 172.30.2.2
    ping -c 3 172.30.3.1
    ping -c 3 172.30.3.2
}

# 验证NAT配置
validate_nat() {
    echo "=== 验证NAT配置 ==="
    
    # 检查NAT配置
    show ip nat translations
    show ip nat statistics
    show ip nat pool
    
    # 检查访问控制列表
    show access-lists
    show ip access-lists
    
    # 检查NAT接口
    show ip nat interfaces
    
    # 测试NAT功能
    ping -c 3 8.8.8.8 source vlan 501
    ping -c 3 8.8.8.8 source vlan 502
}

# 验证VPN配置
validate_vpn() {
    echo "=== 验证VPN配置 ==="
    
    # 检查ISAKMP状态
    show crypto isakmp sa
    show crypto isakmp sa detail
    show crypto isakmp policy
    
    # 检查IPSec状态
    show crypto ipsec sa
    show crypto ipsec sa detail
    show crypto ipsec transform-set
    
    # 检查隧道状态
    show interface tunnel 0
    
    # 测试站点间连通性
    ping -c 3 193.2.2.1
    ping -c 3 193.2.2.1 source 172.30.10.1
}

# 验证QoS配置
validate_qos() {
    echo "=== 验证QoS配置 ==="
    
    # 检查策略映射
    show policy-map
    show class-map
    
    # 检查接口策略应用
    show policy-map interface
    show policy-map interface vlan 503
    show policy-map interface vlan 513
    
    # 检查QoS统计
    show policy-map interface vlan 503 input
    show policy-map interface vlan 503 output
}

# 验证安全配置
validate_security() {
    echo "=== 验证安全配置 ==="
    
    # 检查SSH配置
    show ip ssh
    show crypto key mypubkey rsa
    
    # 检查访问控制列表
    show access-lists 10
    show access-lists 100
    show access-lists 110
    
    # 检查端口安全
    show port-security
    show port-security interface f0/1
    show port-security interface f0/2
}

# 验证监控配置
validate_monitoring() {
    echo "=== 验证监控配置 ==="
    
    # 检查SNMP配置
    show snmp community
    show snmp host
    
    # 检查日志配置
    show logging
    show logging history
    
    # 检查NTP状态
    show ntp status
    show ntp associations
    
    # 检查系统资源
    show memory
    show processes cpu
}

# 主验证函数
main_validation() {
    echo "开始配置验证..."
    validate_connectivity
    validate_routing
    validate_vlan
    validate_nat
    validate_vpn
    validate_qos
    validate_security
    validate_monitoring
    echo "配置验证完成"
}

# 执行验证
main_validation
```

#### 步骤9.2：创建性能测试脚本

**网络性能测试脚本：**
```bash
#!/bin/bash
# 网络性能测试脚本 - performance_test.sh

echo "=========================================="
echo "网络性能测试报告 - $(date)"
echo "=========================================="

# 测试带宽
test_bandwidth() {
    echo "=== 带宽测试 ==="
    
    # 测试内部网络带宽
    iperf3 -c 172.30.1.1 -t 30
    iperf3 -c 172.30.2.1 -t 30
    iperf3 -c 172.30.3.1 -t 30
    
    # 测试外部网络带宽
    iperf3 -c 8.8.8.8 -t 30
}

# 测试延迟
test_latency() {
    echo "=== 延迟测试 ==="
    
    # 测试内部网络延迟
    ping -c 100 172.30.1.1
    ping -c 100 172.30.2.1
    ping -c 100 172.30.3.1
    
    # 测试外部网络延迟
    ping -c 100 8.8.8.8
    ping -c 100 1.1.1.1
}

# 测试VPN性能
test_vpn_performance() {
    echo "=== VPN性能测试 ==="
    
    # 测试VPN隧道延迟
    ping -c 50 193.2.2.1
    ping -c 50 193.2.2.1 source 172.30.10.1
    
    # 测试VPN隧道带宽
    iperf3 -c 193.2.2.1 -t 30
}

# 测试QoS性能
test_qos_performance() {
    echo "=== QoS性能测试 ==="
    
    # 测试不同优先级的流量
    # 这里需要根据实际的QoS配置进行调整
    echo "QoS性能测试需要根据实际配置进行调整"
}

# 主测试函数
main_performance_test() {
    echo "开始性能测试..."
    test_bandwidth
    test_latency
    test_vpn_performance
    test_qos_performance
    echo "性能测试完成"
}

# 执行测试
main_performance_test
```

#### 步骤9.3：创建故障排除脚本

**故障排除脚本：**
```bash
#!/bin/bash
# 故障排除脚本 - troubleshooting.sh

echo "=========================================="
echo "故障排除报告 - $(date)"
echo "=========================================="

# 检查常见问题
check_common_issues() {
    echo "=== 检查常见问题 ==="
    
    # 检查接口状态
    echo "检查接口状态..."
    show ip interface brief | grep "down"
    
    # 检查OSPF邻居问题
    echo "检查OSPF邻居..."
    show ospf neighbor | grep -v "FULL"
    
    # 检查VLAN问题
    echo "检查VLAN状态..."
    show vlan | grep "active"
    
    # 检查NAT问题
    echo "检查NAT状态..."
    show ip nat translations | wc -l
    
    # 检查VPN问题
    echo "检查VPN状态..."
    show crypto isakmp sa | grep -v "QM_IDLE"
    
    # 检查端口安全违规
    echo "检查端口安全..."
    show port-security violations
}

# 收集诊断信息
collect_diagnostics() {
    echo "=== 收集诊断信息 ==="
    
    # 收集接口信息
    show interfaces > /tmp/interfaces.txt
    show ip interface brief > /tmp/ip_interfaces.txt
    
    # 收集路由信息
    show ip route > /tmp/ip_routes.txt
    show ipv6 route > /tmp/ipv6_routes.txt
    
    # 收集OSPF信息
    show ospf neighbor > /tmp/ospf_neighbors.txt
    show ospf database > /tmp/ospf_database.txt
    
    # 收集VLAN信息
    show vlan > /tmp/vlans.txt
    show interfaces trunk > /tmp/trunks.txt
    
    # 收集NAT信息
    show ip nat translations > /tmp/nat_translations.txt
    show ip nat statistics > /tmp/nat_statistics.txt
    
    # 收集VPN信息
    show crypto isakmp sa > /tmp/isakmp_sa.txt
    show crypto ipsec sa > /tmp/ipsec_sa.txt
    
    # 收集日志信息
    show logging > /tmp/logging.txt
    
    echo "诊断信息已保存到 /tmp/ 目录"
}

# 主故障排除函数
main_troubleshooting() {
    echo "开始故障排除..."
    check_common_issues
    collect_diagnostics
    echo "故障排除完成"
}

# 执行故障排除
main_troubleshooting
```

#### 步骤9.4：创建自动化测试脚本

**自动化测试脚本：**
```bash
#!/bin/bash
# 自动化测试脚本 - automated_test.sh

# 配置变量
TEST_RESULTS="/var/log/test_results.log"
PASS_COUNT=0
FAIL_COUNT=0

# 测试函数
run_test() {
    local test_name="$1"
    local test_command="$2"
    local expected_result="$3"
    
    echo "运行测试: $test_name"
    
    if eval "$test_command" | grep -q "$expected_result"; then
        echo "✓ 测试通过: $test_name"
        echo "PASS: $test_name" >> $TEST_RESULTS
        ((PASS_COUNT++))
    else
        echo "✗ 测试失败: $test_name"
        echo "FAIL: $test_name" >> $TEST_RESULTS
        ((FAIL_COUNT++))
    fi
}

# 运行所有测试
run_all_tests() {
    echo "开始自动化测试..."
    
    # 基础连通性测试
    run_test "网关连通性测试" "ping -c 1 193.10.10.1" "1 received"
    run_test "内部网络连通性测试" "ping -c 1 172.30.10.1" "1 received"
    
    # 路由测试
    run_test "OSPF邻居测试" "show ospf neighbor" "FULL"
    run_test "默认路由测试" "show ip route 0.0.0.0" "0.0.0.0"
    
    # VLAN测试
    run_test "VLAN状态测试" "show vlan" "active"
    run_test "Trunk接口测试" "show interfaces trunk" "trunking"
    
    # NAT测试
    run_test "NAT配置测试" "show ip nat pool" "Pool"
    run_test "NAT转换测试" "show ip nat translations" "---"
    
    # VPN测试
    run_test "VPN隧道测试" "show crypto isakmp sa" "QM_IDLE"
    run_test "IPSec状态测试" "show crypto ipsec sa" "inbound"
    
    # QoS测试
    run_test "QoS策略测试" "show policy-map" "Policy"
    run_test "类映射测试" "show class-map" "Class"
    
    # 安全测试
    run_test "SSH配置测试" "show ip ssh" "SSH"
    run_test "端口安全测试" "show port-security" "Port Security"
    
    # 监控测试
    run_test "SNMP配置测试" "show snmp community" "public"
    run_test "日志配置测试" "show logging" "Logging"
    
    echo "自动化测试完成"
    echo "通过: $PASS_COUNT, 失败: $FAIL_COUNT"
    echo "测试结果已保存到 $TEST_RESULTS"
}

# 执行自动化测试
run_all_tests
```

#### 步骤9.5：验证测试脚本

**验证命令：**
```bash
# 运行配置验证脚本
./config_validation.sh

# 运行性能测试脚本
./performance_test.sh

# 运行故障排除脚本
./troubleshooting.sh

# 运行自动化测试脚本
./automated_test.sh

# 检查测试结果
cat /var/log/test_results.log
cat /var/log/network_monitor.log

# 查看诊断信息
ls -la /tmp/*.txt
```

---

*本文档提供了按功能模块分步骤的网络架构实施指南，确保实施的逻辑性和完整性。建议严格按照顺序实施，并在每个阶段完成后进行充分测试。所有配置验证和测试脚本都已提供，确保网络架构的正确实施和稳定运行。*
